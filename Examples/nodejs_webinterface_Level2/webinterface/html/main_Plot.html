<html>
<head>



    <div id="Plot"></div>

    <script src = "/socket.io/socket.io.js" > </script>
    <script type=text/javascript src="http://code.jquery.com/jquery-1.7.1.min.js"></script>

    <script src="http://d3lp1msu2r81bx.cloudfront.net/kjs/js/lib/kinetic-v5.0.1.min.js"></script>

    <script defer="defer">
/*
   Create plot
*/


//       var stage = new Kinetic.Stage({
//         container: 'Plot',
//         width: 578,
//         height: 200
//       });
// 
//       var layer = new Kinetic.Layer();
// 
// 
//       // complex dashed and dotted line
//       var blueLine = new Kinetic.Line({
//         points: [73, 70, 340, 23, 450, 60, 500, 20],
//         stroke: 'blue',
//         strokeWidth: 1,
//         lineCap: 'round',
//         lineJoin: 'round'
//         /*
//          * line segments with a length of 29px with a gap
//          * of 20px followed by a line segment of 0.001px (a dot)
//          * followed by a gap of 20px
//          */
//     
//       });
// 
//    
//       layer.add(blueLine);
//       stage.add(layer);
//       
//       //blueLine.points = [13, 10, 340, 23, 450, 60, 500, 20];
//       
//       
//        blueLine.points()[1] = 0;      
//         layer.draw();
//       
//        function PlotDraw(Values) {
// 	      blueLine.points()[1] = Values[0];
// 	      blueLine.points()[3] = Values[0];
// 	      layer.draw();
//        }


  function VectorPlotClass(container, Heigh, Width, Ny) {
      this.container = container;
      this.Ny = Ny; this.Width = Width; this.Heigh = Heigh;

      this.stage = new Kinetic.Stage({
        container: this.container,
        width: this.Width,
        height: this.Heigh
      });

      this.layer = new Kinetic.Layer();


      // complex dashed and dotted line

      var lp=[], i;
      for (i = 0; i < this.Ny; i++) {
        Y = this.Heigh/2 + 0*i*2; X=(this.Width/this.Ny) * i;
        lp[2*i] = X;
        lp[2*i + 1] = Y;
      }
      console.log(lp);
      this.blueLine = new Kinetic.Line({
//        points: [73, 70, 340, 23, 450, 60, 500, 20],
        points: lp,
        stroke: 'green',
        strokeWidth: 3,
        lineCap: 'round',
        lineJoin: 'round'

      });

   
      this.layer.add(this.blueLine);
      this.stage.add(this.layer);
      
       this.PlotDraw = PlotDraw;
       function PlotDraw(Values) {
              var i;
              for (i = 0; i < this.Ny; ++i) {
                Y_norm = Values[0]; Y = Y_norm * ( this.Heigh / 2 ) + this.Heigh / 2;
		this.blueLine.points()[  i*2+1 ] = Y;
              }
              this.layer.draw();
       }

  }

  var Plot = new VectorPlotClass('Plot', 600, 578,  200);

/*
   communication
*/








        var ProtocollConfig;
        var socket = io.connect();
       
	function GetParameterID(ParametersConfig, ParameterName)
	{
	  var P = ParametersConfig;
	  for (key in P) {
	    if (P[key].ParameterName == ParameterName) {
	      return key;
	    }    
	  }
	  return -1;
	}

	function GetParameterID(SourcesConfig, SourceName)
	{
	  var P = SourcesConfig;
	  for (key in P) {
	    if (P[key].SourceName == SourceName) {
	      return key;
	    }    
	  }
	  return -1;
	}


	// console.log(  GetParameterID(ProtocollConfig.ParametersConfig, "Parameter2") );


        socket.on('ProtocollConfig', function (ProtocollConfig__) { 
          // received the protocoll definition
          ProtocollConfig = ProtocollConfig__;
          
          // Set-up the Displays for all Sources
          var htmlcode;

          // Creates a Display for each source
          SourcesConfig = ProtocollConfig.SourcesConfig;
          for (key in SourcesConfig) {
            try {
              htmlcode = htmlcode  + '<br><br><strong>Source Name</strong> ' + SourcesConfig[key].SourceName + '<br>';
              htmlcode = htmlcode  + '<strong>Data:</strong> <div id="Display' + key  + '">--</div>'
            } catch (err) { ; }
            
            htmlcode = htmlcode + ' <br><br> ';
          }
          
          document.getElementById('Displays').innerHTML = htmlcode;

          
          // Creates a ... for each parameter
          ParametersConfig = ProtocollConfig.ParametersConfig;
          htmlcode = '';
          for (key in ParametersConfig) {
            try {
              ParameterName = ParametersConfig[key].ParameterName;
              
              htmlcode = htmlcode  + '<br><br><strong>Parameter Name</strong> ' + ParameterName + '<br>';
              htmlcode = htmlcode  + '<strong>Elements:</strong><br> '
              
              var i;
              for (i=0; i< ParametersConfig[key].NValues; ++i) {
               // htmlcode = htmlcode  + 'e' + i + '<br>';
                htmlcode = htmlcode + '<input id="' + ParameterName + '_' + i + '" type="text" size="20" maxlength="20" value="0.00"><br>';

              }
              
            } catch (err) { ; }
            
            htmlcode = htmlcode + '<input type="button" id="UploadParameters" value="Upload Parameters" onClick="UploadParameters('+key+');">';
            
            htmlcode = htmlcode + ' <br><br> ';

            console.log(htmlcode);
          }
          
//           htmlcode = JSON.stringify(ParametersConfig  );
          
          document.getElementById('Parameters').innerHTML = htmlcode;          
          
          // display the protocoll definition
          htmlcode = JSON.stringify( ProtocollConfig );
          document.getElementById('ProtocollConfiguration').innerHTML = htmlcode;
        });
        
	// wait for new signal-samples
	socket.on('Update', function (data) {
	    //console.log(data);
	    
	    // get configuration
	    NValues = ProtocollConfig.SourcesConfig[data.SourceID].NValues_send;	     
	    Values = data.Data;
	    
            // 
            if (data.SourceID == 0) {
              Plot.PlotDraw(Values);
            }


	    // Update the display for this source. Compose html code for the Display to print the data
	    var htmlcode, i;
	    htmlcode = '#'+NValues+'<br>';
	    for (i=0; i<NValues; ++i) {
	      htmlcode = htmlcode + i + ' = '+Values[i]+'<br>';	      
	    }
	    
	    document.getElementById('Display'+data.SourceID).innerHTML = htmlcode;
	});


    function UploadParameters(ParameterID){
      // update parameters button was clicked; send parameters
      
      console.log(ParameterID);
      
      ParametersConfig = ProtocollConfig.ParametersConfig;
      ParameterName = ParametersConfig[ParameterID].ParameterName;
      
      ParSet = new Array();
      
              var i;
              for (i=0; i< ParametersConfig[ParameterID].NValues; ++i) {
               // htmlcode = htmlcode  + 'e' + i + '<br>';
                htmlid = ParameterName + '_' + i;
                var p1 = document.getElementById(htmlid).value;
                var p1_float = parseFloat(p1.replace(",", ".")); ParSet[i] = p1_float;

              }
      
//       var p1 = document.getElementById('Parameter1').value;
//       var p1_float = parseFloat(p1.replace(",", ".")); ParSet[0] = p1_float;


      socket.emit('ChangeParam_Set', [ParameterID, ParSet] );
    }






    </script>
</head> 
 
<body>
    <strong>GUI-interface to ORTD-simulation</strong>

  <br><br>

  <strong>ProtocollConfiguration:</strong> <div id="ProtocollConfiguration">0</div>
  <br><br>
  
  <strong>Parameters:</strong> <div id="Parameters">0</div>
  
  <strong>Displays:</strong> <div id="Displays">0</div>












    <script defer="defer">

      
    </script>









</body>
</html>